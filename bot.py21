# -*- coding: utf-8 -*-
"""
bot_ultimate_pro_v14_dollar.py
ØªØ­Ø¯ÙŠØ« Ø´Ø§Ù…Ù„ V14:
1. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (Ø³Ø¹Ø± ØµØ±Ù Ù…ØªØºÙŠØ±).
2. ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (USD/SYR).
3. Ø·Ø¨Ù‚Ø© Ø§Ù„ÙˆØ³ÙŠØ· (Mediator) Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©.
4. ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±.
5. Ø¯Ø¹Ù… ÙƒØ§Ù…Ù„ Ù„Ù„ÙÙˆØ§ØµÙ„ Ø§Ù„Ø¹Ø´Ø±ÙŠØ©.
"""

import telebot
from telebot import types
import sqlite3
import threading
import time
import os
import requests
import random
import math
import datetime

# ================= Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª =================
# Ø¶Ø¹ Ø§Ù„ØªÙˆÙƒÙŠÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ù†Ø§
TOKEN = "8052662195:AAGSY5fv37_MSqzWCvf2y29fN--Mr0SrxVw"
ADMIN_ID = 6342993961
DB_FILE = "bot_ultimate_v14.db" 
CHANNEL_USERNAME = "ahmadasadalsh"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Big Boss API
BIG_BOSS_API_URL = "https://api.big-boss-store.com/big-boos/api/client/order"
BIG_BOSS_API_TOKEN = "c9d27c8da440c0be70cbe0db92474a0a6fa69e8a2fadaef3d041fa6d559e2c84"

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø§Ù„ÙŠØ©
WITHDRAW_FEE_PERCENT = 2

bot = telebot.TeleBot(TOKEN)
db_lock = threading.Lock()
admin_states = {} 

# ================= Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =================
def init_db():
    with db_lock:
        conn = sqlite3.connect(DB_FILE)
        cur = conn.cursor()
        
        # 1. Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        cur.execute("""CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY,
            username TEXT,
            balance REAL DEFAULT 0,
            level INTEGER DEFAULT 0,
            total_spent REAL DEFAULT 0,
            banned INTEGER DEFAULT 0,
            join_date INTEGER
        )""")
        
        # [Ø¬Ø¯ÙŠØ¯] Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙˆØ¯ Ù„ØªÙØ¶ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        try: cur.execute("ALTER TABLE users ADD COLUMN currency_pref TEXT DEFAULT 'SYR'")
        except: pass

        # 2. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        cur.execute("""CREATE TABLE IF NOT EXISTS settings (
            key TEXT PRIMARY KEY,
            value TEXT
        )""")

        # 3. Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹
        cur.execute("""CREATE TABLE IF NOT EXISTS payment_methods (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT,
            account_number TEXT,
            details TEXT
        )""")

        # 4. Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        cur.execute("""CREATE TABLE IF NOT EXISTS transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER,
            type TEXT, 
            amount REAL,
            method_name TEXT,
            user_account TEXT,
            proof_image TEXT,
            status TEXT, 
            date INTEGER
        )""")

        # 5. Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…ØªØ¬Ø±
        cur.execute("""CREATE TABLE IF NOT EXISTS categories (id INTEGER PRIMARY KEY AUTOINCREMENT, name TEXT UNIQUE)""")
        cur.execute("""CREATE TABLE IF NOT EXISTS groups (id INTEGER PRIMARY KEY AUTOINCREMENT, category_id INTEGER, name TEXT, image_url TEXT)""")
        
        try: cur.execute("ALTER TABLE groups ADD COLUMN is_active INTEGER DEFAULT 1")
        except: pass

        # [Ø¬Ø¯ÙŠØ¯] Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ³ÙŠØ· (Mediators) - Ø§Ø®ØªÙŠØ§Ø±ÙŠ
        cur.execute("""CREATE TABLE IF NOT EXISTS mediators (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            group_id INTEGER,
            name TEXT
        )""")

        # Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        cur.execute("""CREATE TABLE IF NOT EXISTS products (id INTEGER PRIMARY KEY AUTOINCREMENT, group_id INTEGER, name TEXT, price REAL, api_product_id TEXT)""")
        
        # Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© + Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        try: cur.execute("ALTER TABLE products ADD COLUMN is_quantity INTEGER DEFAULT 0")
        except: pass
        try: cur.execute("ALTER TABLE products ADD COLUMN cost_price REAL DEFAULT 0")
        except: pass
        try: cur.execute("ALTER TABLE products ADD COLUMN min_qty INTEGER DEFAULT 1")
        except: pass
        
        # [Ø¬Ø¯ÙŠØ¯] Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± + Ø±Ø¨Ø· Ø§Ù„ÙˆØ³ÙŠØ·
        try: cur.execute("ALTER TABLE products ADD COLUMN price_usd REAL DEFAULT 0") # Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
        except: pass
        try: cur.execute("ALTER TABLE products ADD COLUMN mediator_id INTEGER DEFAULT 0") # Ø±Ø¨Ø· Ø¨Ø§Ù„ÙˆØ³ÙŠØ·
        except: pass

        # 6. Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        cur.execute("""CREATE TABLE IF NOT EXISTS levels (level_id INTEGER PRIMARY KEY, name TEXT, discount_percent REAL, upgrade_cost INTEGER)""")
     
        # 7. Ø§Ù„Ø·Ù„Ø¨Ø§Øª
        cur.execute("""CREATE TABLE IF NOT EXISTS orders (order_id TEXT PRIMARY KEY, user_id INTEGER, product_name TEXT, price_paid REAL, api_status TEXT, created_at INTEGER, status TEXT)""")
     
        try: cur.execute("ALTER TABLE orders ADD COLUMN quantity INTEGER DEFAULT 1")
        except: pass
        try: cur.execute("ALTER TABLE orders ADD COLUMN cost_at_purchase REAL DEFAULT 0")
        except: pass

        # 8. Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨
        cur.execute("""CREATE TABLE IF NOT EXISTS raffle_entries (
            user_id INTEGER PRIMARY KEY,
            join_date INTEGER
        )""")

        # Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
        cur.execute("SELECT COUNT(*) FROM levels")
        if cur.fetchone()[0] == 0:
            default_levels = [
                (0, "ğŸ†• Ù…Ø¨ØªØ¯Ø¦", 0.0, 0),
                (1, "ğŸ¥‰ Ø¨Ø±ÙˆÙ†Ø²ÙŠ", 2.0, 25000),
                (2, "ğŸ¥ˆ ÙØ¶ÙŠ", 5.0, 75000),
                (3, "ğŸ¥‡ Ø°Ù‡Ø¨ÙŠ", 8.0, 150000),
                (4, "ğŸ’ Ù…Ø§Ø³ÙŠ", 12.0, 300000)
            ]
            cur.executemany("INSERT INTO levels VALUES (?,?,?,?)", default_levels)

        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("start_msg", "ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£ÙØ¶Ù„!"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("terms_msg", "ğŸ“œ **Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…:**\n1. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ©."))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("support_msg", "â˜ï¸ **Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ:**\nØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Ø¹Ø¨Ø± Ø§Ù„Ù…Ø¹Ø±Ù: @YourUser"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("maintenance", "0"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("order_counter", "0"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("raffle_fee", "1000"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("raffle_prize", "12000"))
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("raffle_min_users", "14"))

        # [Ø¬Ø¯ÙŠØ¯] Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ÙˆØ§Ù„ÙˆØ³ÙŠØ·
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("dollar_rate", "15000")) # Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("enable_user_currency", "1")) # Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ø²Ø¨ÙˆÙ† Ø¨ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…Ù„Ø©
        cur.execute("INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)", ("enable_mediator", "0")) # ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ³ÙŠØ·

        conn.commit()
        conn.close()

def db_query(query, args=(), fetch=False, commit=False):
    with db_lock:
        conn = sqlite3.connect(DB_FILE)
        cur = conn.cursor()
        cur.execute(query, args)
        res = None
        if fetch: res = cur.fetchall()
        if commit: conn.commit()
        conn.close()
        return res

def get_setting(key):
    res = db_query("SELECT value FROM settings WHERE key=?", (key,), fetch=True)
    return res[0][0] if res else "0"

def set_setting(key, value):
    db_query("INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)", (key, value), commit=True)

def get_next_order_id():
    current = int(get_setting("order_counter"))
    next_id = current + 1
    set_setting("order_counter", str(next_id))
    return next_id

init_db()

# ================= Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙˆØ­Ø³Ø§Ø¨Ø§Øª =================
def get_user(user_id):
    res = db_query("SELECT * FROM users WHERE id=?", (user_id,), fetch=True)
    return res[0] if res else None

def register_user(user_id, username):
    if not get_user(user_id):
        db_query("INSERT INTO users (id, username, join_date) VALUES (?, ?, ?)", (user_id, username, int(time.time())), commit=True)
        try:
            bot.send_message(ADMIN_ID, f"ğŸ”” **Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙˆØª!**\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: @{username}\nğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: `{user_id}`", parse_mode="Markdown")
        except: pass
    else:
        db_query("UPDATE users SET username=? WHERE id=?", (username, user_id), commit=True)

def get_level_info(level_id):
    res = db_query("SELECT * FROM levels WHERE level_id=?", (level_id,), fetch=True)
    return res[0] if res else (0, "Unknown", 0.0, 999999)

# [Ø¬Ø¯ÙŠØ¯] Ø¯Ø§Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ÙˆØ§Ù„Ø¯ÙŠÙ†Ø§Ø±
def get_product_real_price_syr(product_row):
    """
    ØªÙ‚ÙˆÙ… Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø¨Ø§Ù„Ù„ÙŠØ±Ø© Ø§Ù„Ø³ÙˆØ±ÙŠØ©.
    Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ù…Ù†ØªØ¬ Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± > 0ØŒ ÙŠØªÙ… Ø¶Ø±Ø¨Ù‡ Ø¨Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ.
    ÙˆØ¥Ù„Ø§ ÙŠØªÙ… Ø£Ø®Ø° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø«Ø§Ø¨Øª Ø¨Ø§Ù„Ù„ÙŠØ±Ø©.
    """
    # product_row indices: 0:id, 1:grp, 2:name, 3:price_syr_fixed, 4:api, 5:is_qty, 6:cost, 7:min, 8:price_usd
    fixed_syr = float(product_row[3])
    usd_price = 0.0
    if len(product_row) > 8:
        usd_price = float(product_row[8]) if product_row[8] else 0.0
    
    current_rate = float(get_setting("dollar_rate"))
    
    if usd_price > 0:
        return usd_price * current_rate
    return fixed_syr

def calculate_final_price(original_syr_price, user_level):
    """Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… (Ø¨Ø§Ù„Ù„ÙŠØ±Ø©)"""
    lvl = get_level_info(user_level)
    discount = float(lvl[2])
    price = original_syr_price - (original_syr_price * discount / 100)
    return round(price, 3)

def format_price_display(amount_syr, user_pref_currency):
    """ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¹Ø± (Ø¯ÙˆÙ„Ø§Ø± Ø£Ùˆ Ù„ÙŠØ±Ø©) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø±ØºØ¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
    if user_pref_currency == 'USD':
        rate = float(get_setting("dollar_rate"))
        if rate == 0: rate = 1
        val_usd = amount_syr / rate
        return f"{round(val_usd, 2)} $"
    else:
        return f"{round(amount_syr, 0)} SYR"

def broadcast_message(text, photo_id=None):
    users = db_query("SELECT id FROM users", fetch=True)
    count = 0
    for user in users:
        try:
            if photo_id:
                bot.send_photo(user[0], photo_id, caption=text)
            else:
                bot.send_message(user[0], text)
            count += 1
            time.sleep(0.05)
        except: pass
    return count

def check_auto_promotion(user_id, total_spent, current_level):
    levels = db_query("SELECT * FROM levels ORDER BY level_id ASC", fetch=True)
    eligible_level = current_level
    for lvl in levels:
        if total_spent >= lvl[3]:
            eligible_level = lvl[0]
    
    if eligible_level > current_level:
        db_query("UPDATE users SET level=? WHERE id=?", (eligible_level, user_id), commit=True)
        new_lvl_info = get_level_info(eligible_level)
        try:
            bot.send_message(user_id, f"ğŸ‰ **Ù…Ø¨Ø±ÙˆÙƒ! ØªÙ…Øª ØªØ±Ù‚ÙŠØªÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!**\n\nØ£ØµØ¨Ø­Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **{new_lvl_info[1]}**\nØªØªÙ…ØªØ¹ Ø¨Ø®ØµÙ…: **{new_lvl_info[2]}%** Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ğŸ’")
        except: pass
        return eligible_level
    return current_level

def get_progress_bar(total_spent, current_level):
    next_level_id = current_level + 1
    next_lvl = get_level_info(next_level_id)
    if next_lvl[1] == "Unknown" or next_level_id > 4:
        return "ğŸ† Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù‚Ù…Ø©!", 100
    target = next_lvl[3]
    if target == 0: target = 1
    percent = (total_spent / target) * 100
    if percent > 100: percent = 100
    filled = int(percent / 10)
    bar = "â–“" * filled + "â–‘" * (10 - filled)
    return f"{bar} {int(percent)}%", target - total_spent

# ================= Big Boss API =================
def execute_big_boss_order(user_id, player_id, api_product_id, quantity=1):
    if not api_product_id or str(api_product_id) == "0": 
        return True, "MANUAL_PROCESSING"
        
    headers = {'x-api-key': BIG_BOSS_API_TOKEN}
    payload = {'note': 'true', 'quantity': str(quantity), 'appId': str(player_id), 'productId': str(api_product_id)}
    
    files = []
    with open('temp.txt', 'w') as f: f.write('temp')
    files = [('image', ('temp.txt', open('temp.txt', 'rb'), 'text/plain'))]

    try:
        response = requests.post(BIG_BOSS_API_URL, headers=headers, data=payload, files=files)
        if files: files[0][1][1].close()
        result = response.json()
        
        if response.status_code == 200:
            inner = result.get("result", {})
            if isinstance(inner, dict) and inner.get("orderID") and inner.get("status") != "reject":
                return True, str(inner.get("orderID"))
            if result.get("message") == "Order created successfully": return True, "ØªÙ… (Ø¨Ø¯ÙˆÙ† ID)"
            return False, f"ÙØ´Ù„: {result}"
        return False, f"Ø®Ø·Ø£ Ø®Ø§Ø¯Ù…: {response.status_code}"
    except Exception as e:
        return False, str(e)

# ================= Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (Menus) =================
def main_menu(user_id):
    mk = types.InlineKeyboardMarkup(row_width=2)
    mk.add(types.InlineKeyboardButton("ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", callback_data="shop_cats"),
           types.InlineKeyboardButton("ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ", callback_data="profile"))
    mk.add(types.InlineKeyboardButton("ğŸ¡ Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", callback_data="daily_raffle_menu"))
    mk.add(types.InlineKeyboardButton("ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯", callback_data="deposit"),
           types.InlineKeyboardButton("ğŸ“¤ Ø³Ø­Ø¨ Ø±ØµÙŠØ¯", callback_data="withdraw"))
    mk.add(types.InlineKeyboardButton("â˜ï¸ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ", callback_data="support_view"),
           types.InlineKeyboardButton("ğŸ“œ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…", callback_data="terms_view"))
    
    # [Ø¬Ø¯ÙŠØ¯] Ø²Ø± ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ø°Ø§ ÙƒØ§Ù† Ù…ÙØ¹Ù„
    if get_setting("enable_user_currency") == "1":
        user_pref = db_query("SELECT currency_pref FROM users WHERE id=?", (user_id,), fetch=True)[0][0]
        cur_icon = "ğŸ‡ºğŸ‡¸" if user_pref == "USD" else "ğŸ‡¸ğŸ‡¾"
        mk.add(types.InlineKeyboardButton(f"ğŸ’± Ø§Ù„Ø¹Ù…Ù„Ø©: {user_pref} {cur_icon}", callback_data="toggle_currency"))

    if user_id == ADMIN_ID:
        mk.add(types.InlineKeyboardButton("ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", callback_data="admin_panel"))
    return mk

def admin_menu():
    mk = types.InlineKeyboardMarkup(row_width=2)
    mk.add(types.InlineKeyboardButton("ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©)", callback_data="adm_manual_orders"))
    mk.add(types.InlineKeyboardButton("ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø£Ø±Ø¨Ø§Ø­ÙŠ", callback_data="adm_profits"))
    mk.add(types.InlineKeyboardButton("ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©", callback_data="adm_stats"))
    mk.add(types.InlineKeyboardButton("ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª", callback_data="adm_products"),
           types.InlineKeyboardButton("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="adm_users"))
    mk.add(types.InlineKeyboardButton("ğŸ… ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆÙ‰ (Ø³Ø±ÙŠØ¹)", callback_data="adm_quick_level"),
           types.InlineKeyboardButton("ğŸ’° Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø©", callback_data="adm_manage_balance"))
    mk.add(types.InlineKeyboardButton("ğŸ¡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­Ø¨", callback_data="adm_raffle_manage"),
           types.InlineKeyboardButton("ğŸ’¸ Ø·Ù„Ø¨Ø§Øª Ù…Ø§Ù„ÙŠØ©", callback_data="adm_transactions"))
    mk.add(types.InlineKeyboardButton("ğŸ’³ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹", callback_data="adm_methods"),
           types.InlineKeyboardButton("âœï¸ Ø§Ù„Ù†ØµÙˆØµ", callback_data="adm_texts"))
    mk.add(types.InlineKeyboardButton("ğŸ’ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª", callback_data="adm_levels"),
           types.InlineKeyboardButton("ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ÙƒÙ„", callback_data="adm_broadcast"))
    mk.add(types.InlineKeyboardButton("ğŸ› ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª", callback_data="adm_grp_status"))
    
    # [Ø¬Ø¯ÙŠØ¯] Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    mk.add(types.InlineKeyboardButton("ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù", callback_data="adm_set_rate"),
           types.InlineKeyboardButton("ğŸ”˜ Ø²Ø± Ø§Ù„ÙˆØ³ÙŠØ·", callback_data="adm_toggle_mediator"))
    mk.add(types.InlineKeyboardButton("ğŸ’± Ø¹Ù…Ù„Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†", callback_data="adm_toggle_user_cur"),
           types.InlineKeyboardButton("â˜ï¸ Ø±ÙØ¹ Ù„Ù„Ø³ÙŠØ±ÙØ±", callback_data="adm_server_help"))

    mk.add(types.InlineKeyboardButton("ğŸ›‘ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©", callback_data="adm_maintenance"),
           types.InlineKeyboardButton("ğŸ”™ Ø®Ø±ÙˆØ¬", callback_data="home"))
    return mk

# ================= Ø§Ù„Ø£ÙˆØ§Ù…Ø± =================
@bot.message_handler(commands=['start'])
def cmd_start(message):
    uid = message.from_user.id
    register_user(uid, message.from_user.username)
    
    maint = get_setting("maintenance")
    if maint == "1" and uid != ADMIN_ID:
        bot.send_message(uid, "âš ï¸ **Ø§Ù„Ø¨ÙˆØª Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©.**\nÙ†Ø¹Ù…Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø³Ù†Ø¹ÙˆØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹!", parse_mode="Markdown")
        return

    if CHANNEL_USERNAME:
        try:
            stat = bot.get_chat_member(f"@{CHANNEL_USERNAME}", uid).status
            if stat in ['left', 'kicked']:
                mk = types.InlineKeyboardMarkup()
                mk.add(types.InlineKeyboardButton("Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø©", url=f"t.me/{CHANNEL_USERNAME}"))
                mk.add(types.InlineKeyboardButton("ØªØ­Ù‚Ù‚ âœ…", callback_data="home"))
                bot.send_message(uid, "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹.", reply_markup=mk)
                return
        except: pass
        
    welcome_text = get_setting("start_msg")
    bot.send_message(uid, welcome_text, reply_markup=main_menu(uid))

# ================= Callbacks =================
@bot.callback_query_handler(func=lambda call: True)
def handle_callback(call):
    uid = call.from_user.id
    data = call.data
    user_data = get_user(uid)

    if data.startswith("do_set_lvl_"):
        if uid != ADMIN_ID: return
        parts = data.split("_")
        target_id = int(parts[3])
        target_lvl = int(parts[4])
        
        db_query("UPDATE users SET level=? WHERE id=?", (target_lvl, target_id), commit=True)
        lvl_name = get_level_info(target_lvl)[1]
        
        bot.answer_callback_query(call.id, "âœ… ØªÙ… Ø§Ù„ØªØºÙŠÙŠØ± Ø¨Ù†Ø¬Ø§Ø­")
        bot.edit_message_text(f"âœ… **ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰!**\n\nØ§Ù„Ù…Ø³ØªØ®Ø¯Ù…: `{target_id}`\nØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯: **{lvl_name}**", uid, call.message.message_id, parse_mode="Markdown")
        try:
            bot.send_message(target_id, f"ğŸ‰ **ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ!** ğŸ‰\n\nØªÙ… ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆØ§Ùƒ ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©!\nØ£ØµØ¨Ø­Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **{lvl_name}** ğŸ’", parse_mode="Markdown")
        except: pass
        return 

    maint = get_setting("maintenance")
    if maint == "1" and uid != ADMIN_ID:
        bot.answer_callback_query(call.id, "Ø§Ù„Ø¨ÙˆØª ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©", show_alert=True)
        return

    if data == "home":
        bot.edit_message_text(get_setting("start_msg"), uid, call.message.message_id, reply_markup=main_menu(uid))
    
    # [Ø¬Ø¯ÙŠØ¯] ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©
    elif data == "toggle_currency":
        curr = user_data[7] if len(user_data) > 7 else "SYR" # Assuming idx 7 is currency
        new_curr = "USD" if curr == "SYR" else "SYR"
        db_query("UPDATE users SET currency_pref=? WHERE id=?", (new_curr, uid), commit=True)
        bot.answer_callback_query(call.id, f"ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ {new_curr}")
        bot.edit_message_reply_markup(uid, call.message.message_id, reply_markup=main_menu(uid))

    elif data == "profile":
        lvl = get_level_info(user_data[3])
        bar, remaining = get_progress_bar(user_data[4], user_data[3])
        rem_txt = f"\nğŸ¯ Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ: {remaining} SYR" if isinstance(remaining, (int, float)) else ""
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø­Ø³Ø¨ Ø§Ù„ØªÙØ¶ÙŠÙ„
        user_pref = user_data[7] if len(user_data) > 7 else "SYR"
        balance_display = format_price_display(user_data[2], user_pref)
        spent_display = format_price_display(user_data[4], user_pref)

        txt = (f"ğŸ‘¤ **Ø­Ø³Ø§Ø¨ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ**\n"
               f"ğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: `{uid}`\n"
               f"ğŸ’° Ø§Ù„Ø±ØµÙŠØ¯: **{balance_display}**\n"
               f"ğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚: {spent_display}\n"
               f"â–â–â–â–â–â–â–â–\n"
               f"â­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: **{lvl[1]}**\n"
               f"ğŸ“‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø®ØµÙ…: **{lvl[2]}%**\n"
               f"ğŸ“Š Ø§Ù„ØªÙ‚Ø¯Ù…: {bar}{rem_txt}")
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="home"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    # --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø³Ø­Ø¨ (Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©) ---
    elif data == "daily_raffle_menu":
        fee = int(get_setting("raffle_fee"))
        prize = int(get_setting("raffle_prize"))
        existing = db_query("SELECT * FROM raffle_entries WHERE user_id=?", (uid,), fetch=True)
        
        txt = f"ğŸ¡ **Ø§Ù„Ø¹Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ÙˆØ§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙƒØ¨ÙŠØ±!**\n\n" \
              f"ğŸ’° **ØªÙƒÙ„ÙØ© Ø§Ù„Ø¯Ø®ÙˆÙ„:** {fee} SYR\n" \
              f"ğŸ† **Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„ÙƒØ¨Ø±Ù‰:** {prize} SYR\n\n" \
              f"ğŸ’¡ ÙƒÙŠÙ ØªØ¹Ù…Ù„ØŸ\n" \
              f"Ø§Ø¯ÙØ¹ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©. ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø² Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¹Ø¯Ø¯.\n"
        
        mk = types.InlineKeyboardMarkup()
        if existing:
            txt += "\nâœ… **Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ.**\nØ§Ù†ØªØ¸Ø± Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ§Ø¦Ø²!"
        else:
            mk.add(types.InlineKeyboardButton(f"ğŸŸ Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù† ({fee} SYR)", callback_data="join_raffle_confirm"))
        
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="home"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    elif data == "join_raffle_confirm":
        fee = int(get_setting("raffle_fee"))
        if user_data[2] < fee:
            bot.answer_callback_query(call.id, "ğŸš« Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ!", show_alert=True)
            return

        db_query("UPDATE users SET balance = balance - ? WHERE id=?", (fee, uid), commit=True)
        db_query("INSERT OR IGNORE INTO raffle_entries (user_id, join_date) VALUES (?, ?)", (uid, int(time.time())), commit=True)
        
        bot.answer_callback_query(call.id, "ğŸ‰ ØªÙ… Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", show_alert=True)
        bot.edit_message_text("âœ… **ØªÙ… Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!**\n\nØ­Ø¸Ø§Ù‹ Ù…ÙˆÙÙ‚Ø§Ù‹! Ø³ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ§Ø¦Ø² Ù‚Ø±ÙŠØ¨Ø§Ù‹.", uid, call.message.message_id, parse_mode="Markdown", reply_markup=main_menu(uid))

    elif data == "support_view":
        bot.edit_message_text(get_setting("support_msg"), uid, call.message.message_id, parse_mode="Markdown", 
                              reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="home")))

    elif data == "terms_view":
        bot.edit_message_text(get_setting("terms_msg"), uid, call.message.message_id, parse_mode="Markdown", 
                              reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="home")))

    # --- Ø§Ù„Ù…ØªØ¬Ø± ---
    elif data == "shop_cats":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup(row_width=1)
        for c in cats: mk.add(types.InlineKeyboardButton(f"{c[1]}", callback_data=f"cat_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="home"))
        bot.edit_message_text("ğŸ›’ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("cat_"):
        cid = int(data.split("_")[1])
        groups = db_query("SELECT * FROM groups WHERE category_id=?", (cid,), fetch=True)
        mk = types.InlineKeyboardMarkup(row_width=2)
        
        for g in groups:
            is_active = g[4] if len(g) > 4 else 1 
            grp_name = g[2]
            
            if is_active == 1:
                mk.add(types.InlineKeyboardButton(f"{grp_name}", callback_data=f"grp_{g[0]}"))
            else:
                mk.add(types.InlineKeyboardButton(f"âš« {grp_name} (ØºÙŠØ± Ù…ØªÙˆÙØ±)", callback_data=f"disabled_grp_{g[0]}"))

        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="shop_cats"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("disabled_grp_"):
        bot.answer_callback_query(call.id, "â›” Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹!", show_alert=True)

    elif data.startswith("grp_"):
        gid = int(data.split("_")[1])
        
        # [Ø¬Ø¯ÙŠØ¯] Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ³ÙŠØ·
        enable_mediator = get_setting("enable_mediator") == "1"
        if enable_mediator:
            # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆØ³ÙŠØ· Ù…ÙØ¹Ù„Ø§Ù‹ØŒ Ù†Ù†ØªÙ‚Ù„ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡
            mediators = db_query("SELECT * FROM mediators WHERE group_id=?", (gid,), fetch=True)
            mk = types.InlineKeyboardMarkup(row_width=2)
            # Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ (Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªÙŠ Ù„ÙŠØ³ Ù„Ù‡Ø§ ÙˆØ³ÙŠØ·)
            mk.add(types.InlineKeyboardButton("ğŸ“‚ Ø¹Ø§Ù… / Ø§Ù„ÙƒÙ„", callback_data=f"med_0_{gid}"))
            for m in mediators:
                mk.add(types.InlineKeyboardButton(f"ğŸ”¹ {m[2]}", callback_data=f"med_{m[0]}_{gid}"))
            
            try:
                parent_cat = db_query('SELECT category_id FROM groups WHERE id=?', (gid,), fetch=True)[0][0]
                mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data=f"cat_{parent_cat}"))
            except: pass
            
            bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ:", uid, call.message.message_id, reply_markup=mk)
        else:
            # Ø¥Ø°Ø§ Ø§Ù„ÙˆØ³ÙŠØ· Ù…Ø¹Ø·Ù„ØŒ Ù†Ø°Ù‡Ø¨ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª (Ù…Ø¹ ØªÙ…Ø±ÙŠØ± mediator_id=0 Ù„ÙŠØ¹Ù†ÙŠ Ø§Ù„ÙƒÙ„)
            handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': f'med_all_{gid}', 'message': call.message, 'id': call.id}))

    elif data.startswith("med_"):
        # med_MediatorID_GroupID  OR med_all_GroupID
        parts = data.split("_")
        med_id = parts[1] # ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† "all" Ø£Ùˆ Ø±Ù‚Ù…
        gid = int(parts[2])
        
        query = "SELECT * FROM products WHERE group_id=?"
        args = [gid]
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù† id Ù…Ø­Ø¯Ø¯ (Ù„ÙŠØ³ all ÙˆÙ„ÙŠØ³ 0 Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„) ÙŠÙ…ÙƒÙ† ØªØ®ØµÙŠØµ Ø§Ù„ÙÙ„ØªØ±Ø© Ù‡Ù†Ø§
        # Ù„ÙƒÙ† Ù„Ù„ØªØ¨Ø³ÙŠØ·ØŒ Ø¥Ø°Ø§ Ø§Ø®ØªØ±Ù†Ø§ ÙˆØ³ÙŠØ·ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¨Ø¹Ø© Ù„Ù‡. 
        # Ù…Ù„Ø§Ø­Ø¸Ø©: ÙÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ mediator_idØŒ Ù„Ø°Ù„Ùƒ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø³ØªØ¸Ù‡Ø± ÙÙŠ "Ø¹Ø§Ù…" Ø¥Ø°Ø§ Ø£Ø¶ÙÙ†Ø§ Ø´Ø±Ø·
        if med_id != "all" and med_id != "0":
             query += " AND mediator_id=?"
             args.append(int(med_id))
        elif med_id == "0":
             # Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ÙÙ‚Ø·
             query += " AND (mediator_id IS NULL OR mediator_id=0)"

        prods = db_query(query, tuple(args), fetch=True)
        mk = types.InlineKeyboardMarkup(row_width=1)
        
        user_pref = user_data[7] if len(user_data) > 7 else "SYR"

        for p in prods:
            is_qty_prod = (len(p) > 5 and p[5] == 1)
            
            # [Ø¬Ø¯ÙŠØ¯] Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ (Ø¯ÙˆÙ„Ø§Ø± Ø£Ùˆ Ù„ÙŠØ±Ø©)
            real_base_price = get_product_real_price_syr(p)
            
            if is_qty_prod:
                # Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„ÙƒÙ…ÙŠØ©ØŒ Ø§Ù„Ø³Ø¹Ø± Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
                # Ù„Ø§ Ù†Ø·Ø¨Ù‚ Ø®ØµÙ… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¹Ù„Ù‰ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ù‡Ù†Ø§ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·ØŒ Ø£Ùˆ Ù†Ø·Ø¨Ù‚Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø±ØºØ¨Ø©.
                # Ø³Ù†Ø¹Ø±Ø¶ Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„ØµØ§ÙÙŠ.
                price_display = format_price_display(real_base_price, user_pref)
                price_txt = f"{price_display} (Ù„Ù„Ø­Ø¨Ø©)"
            else:
                final_syr = calculate_final_price(real_base_price, user_data[3])
                price_display = format_price_display(final_syr, user_pref)
                price_txt = f"{price_display}"
        
            mk.add(types.InlineKeyboardButton(f"{p[2]} | {price_txt}", callback_data=f"buy_{p[0]}"))
        
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data=f"grp_{gid}" if get_setting("enable_mediator")=="1" else f"cat_{db_query('SELECT category_id FROM groups WHERE id=?', (gid,), fetch=True)[0][0]}"))

        grp_img = db_query("SELECT image_url FROM groups WHERE id=?", (gid,), fetch=True)[0][0]
        caption = "ğŸ‘‡ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©:"
        if grp_img:
            try:
                bot.send_photo(uid, grp_img, caption=caption, reply_markup=mk)
                bot.delete_message(uid, call.message.message_id)
            except: bot.edit_message_text(caption, uid, call.message.message_id, reply_markup=mk)
        else: bot.edit_message_text(caption, uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("buy_"):
        pid = int(data.split("_")[1])
        prod = db_query("SELECT * FROM products WHERE id=?", (pid,), fetch=True)[0]
        
        is_qty_prod = (len(prod) > 5 and prod[5] == 1)
        
        # [Ø¬Ø¯ÙŠØ¯] Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        real_base_price_syr = get_product_real_price_syr(prod)
        user_pref = user_data[7] if len(user_data) > 7 else "SYR"

        if is_qty_prod:
            min_qty = prod[7] if len(prod) > 7 else 1
            unit_price_disp = format_price_display(real_base_price_syr, user_pref)
            
            msg_text = (f"ğŸ“ **Ø·Ù„Ø¨ ÙƒÙ…ÙŠØ§Øª: {prod[2]}**\n"
                        f"ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø©: **{unit_price_disp}**\n"
                        f"ğŸ”¢ Ø£Ù‚Ù„ ÙƒÙ…ÙŠØ©: **{min_qty}**\n\n"
                        f"ğŸ‘‡ **Ø£Ø±Ø³Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø§Ù„Ø¢Ù† (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·):**\n"
                        f"Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø¨ÙˆØª Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.")
            bot.send_message(uid, msg_text, parse_mode="Markdown")
            admin_states[uid] = {"action": "wait_qty_input", "prod_id": pid, "min_qty": min_qty}
        else:
            final_price = calculate_final_price(real_base_price_syr, user_data[3])
            price_disp = format_price_display(final_price, user_pref)
            
            if user_data[2] < final_price:
                bot.answer_callback_query(call.id, "ğŸš« Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§Ù!", show_alert=True)
                return

            is_manual = (prod[4] == "0" or not prod[4])
            type_txt = "(ØªØ³Ù„ÙŠÙ… ÙŠØ¯ÙˆÙŠ ğŸ› ï¸)" if is_manual else "(ØªØ³Ù„ÙŠÙ… ÙÙˆØ±ÙŠ âš¡)"
            
            msg = bot.send_message(uid, f"ğŸ“ Ø´Ø±Ø§Ø¡: {prod[2]}\n{type_txt}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {price_disp}\n\nğŸ†” **Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ (ID) Ø§Ù„Ø¢Ù†:**")
            admin_states[uid] = {"action": "wait_player_id", "prod_id": pid, "price": final_price, "is_manual": is_manual}

    # --- Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨ ---
    elif data == "deposit":
        methods = db_query("SELECT * FROM payment_methods", fetch=True)
        mk = types.InlineKeyboardMarkup()
        if not methods:
            bot.answer_callback_query(call.id, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø¯ÙØ¹ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹", show_alert=True)
            return
        for m in methods:
            mk.add(types.InlineKeyboardButton(f"ğŸ“¥ {m[1]}", callback_data=f"dep_meth_{m[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø¥Ù„ØºØ§Ø¡", callback_data="home"))
        bot.edit_message_text("ğŸ’³ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("dep_meth_"):
        mid = int(data.split("_")[2])
        meth = db_query("SELECT * FROM payment_methods WHERE id=?", (mid,), fetch=True)[0]
        info = f"ğŸ’³ **Ø¥ÙŠØ¯Ø§Ø¹ Ø¹Ø¨Ø± {meth[1]}**\n\nğŸ”¢ Ø§Ù„Ø±Ù‚Ù…: `{meth[2]}`\nğŸ“ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª: {meth[3]}\n\nğŸ‘‡ **Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ (Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·):**"
        bot.edit_message_text(info, uid, call.message.message_id, parse_mode="Markdown")
        admin_states[uid] = {"action": "dep_wait_amount", "method_name": meth[1]}

    elif data == "withdraw":
        methods = db_query("SELECT * FROM payment_methods", fetch=True)
        mk = types.InlineKeyboardMarkup()
        if not methods:
            bot.answer_callback_query(call.id, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ø±Ù‚ Ø³Ø­Ø¨ Ù…ØªØ§Ø­Ø©", show_alert=True)
            return
        for m in methods:
            mk.add(types.InlineKeyboardButton(f"ğŸ“¤ {m[1]}", callback_data=f"wd_meth_{m[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø¥Ù„ØºØ§Ø¡", callback_data="home"))
        bot.edit_message_text("ğŸ’³ Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø³Ø­Ø¨:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("wd_meth_"):
        mid = int(data.split("_")[2])
        meth = db_query("SELECT * FROM payment_methods WHERE id=?", (mid,), fetch=True)[0]
        bot.edit_message_text(f"ğŸ“¤ Ø³Ø­Ø¨ Ø¹Ø¨Ø± {meth[1]}\nâš ï¸ Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ø³Ø­Ø¨: {WITHDRAW_FEE_PERCENT}%\n\nğŸ‘‡ **Ø£Ø±Ø³Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø³Ø­Ø¨Ù‡:**", uid, call.message.message_id)
        admin_states[uid] = {"action": "wd_wait_amount", "method_name": meth[1]}

    # ================= Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© =================
    elif data == "admin_panel":
        if uid == ADMIN_ID: bot.edit_message_text("ğŸ›  Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†:", uid, call.message.message_id, reply_markup=admin_menu())

    # [Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©] Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±Ø¨Ø§Ø­
    elif data == "adm_profits":
        if uid != ADMIN_ID: return
        today = datetime.date.today()
        first_day = today.replace(day=1)
        start_of_month_ts = time.mktime(first_day.timetuple())
        
        m_stats = db_query("SELECT SUM(price_paid), SUM(cost_at_purchase) FROM orders WHERE status IN ('completed', 'completed_manual') AND created_at >= ?", (start_of_month_ts,), fetch=True)[0]
        m_rev = m_stats[0] or 0
        m_cost = m_stats[1] or 0
        m_prof = m_rev - m_cost
        
        a_stats = db_query("SELECT SUM(price_paid), SUM(cost_at_purchase) FROM orders WHERE status IN ('completed', 'completed_manual')", fetch=True)[0]
        a_rev = a_stats[0] or 0
        a_cost = a_stats[1] or 0
        a_prof = a_rev - a_cost
        
        txt = (f"ğŸ’° **ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­**\n\n"
               f"ğŸ“… **Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±:**\nğŸ“¥ Ù…Ø¨ÙŠØ¹Ø§Øª: {round(m_rev, 2)}\nğŸ“¤ ØªÙƒÙ„ÙØ©: {round(m_cost, 2)}\nâœ… **ØµØ§ÙÙŠ: {round(m_prof, 2)}**\n\n"
               f"ğŸ“‚ **Ø§Ù„ÙƒÙ„:**\nğŸ“¥ Ù…Ø¨ÙŠØ¹Ø§Øª: {round(a_rev, 2)}\nğŸ“¤ ØªÙƒÙ„ÙØ©: {round(a_cost, 2)}\nâœ… **ØµØ§ÙÙŠ: {round(a_prof, 2)}**")
        
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ”„ ØªØ­Ø¯ÙŠØ«", callback_data="adm_profits"), types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    # [Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©] Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© (Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©)
    elif data == "adm_manual_orders":
        if uid != ADMIN_ID: return
        orders = db_query("SELECT * FROM orders WHERE status='pending_manual' ORDER BY created_at ASC", fetch=True)
        if not orders:
            bot.answer_callback_query(call.id, "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©!", show_alert=True)
            return
        
        mk = types.InlineKeyboardMarkup(row_width=1)
        for o in orders:
            u_name = get_user(o[1])[1]
            mk.add(types.InlineKeyboardButton(f"#{o[0]} | {u_name} | {o[2]}", callback_data=f"man_ord_view_{o[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(f"ğŸ“‹ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ({len(orders)}):", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("man_ord_view_"):
        oid = data.split("_")[3]
        o = db_query("SELECT * FROM orders WHERE order_id=?", (oid,), fetch=True)
        if not o: return
        o = o[0]
        qty_info = f" (x{o[7]})" if len(o) > 7 and o[7] > 1 else ""
        txt = f"ğŸ“ **Ø·Ù„Ø¨ #{o[0]}**\nğŸ‘¤ ID: `{o[1]}`\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: {o[2]}{qty_info}\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {o[3]}\nâš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: Ø§Ù†ØªØ¸Ø§Ø±"
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("âœ… Ù‚Ø¨ÙˆÙ„ (ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°)", callback_data=f"man_act_ok_{oid}"))
        mk.add(types.InlineKeyboardButton("âŒ Ø±ÙØ¶ (Ø§Ø³ØªØ±Ø¬Ø§Ø¹)", callback_data=f"man_act_no_{oid}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_manual_orders"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    elif data.startswith("man_act_ok_"):
        oid = data.split("_")[3]
        db_query("UPDATE orders SET status='completed_manual' WHERE order_id=?", (oid,), commit=True)
        o = db_query("SELECT user_id FROM orders WHERE order_id=?", (oid,), fetch=True)[0]
        try: bot.send_message(o[0], f"âœ… **ØªÙ… ØªÙ†ÙÙŠØ° Ø·Ù„Ø¨Ùƒ #{oid} Ø¨Ù†Ø¬Ø§Ø­!**")
        except: pass
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„")
        handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': 'adm_manual_orders', 'message': call.message, 'id': call.id}))

    elif data.startswith("man_act_no_"):
        oid = data.split("_")[3]
        bot.send_message(uid, "ğŸ“ Ø£Ø±Ø³Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…):")
        admin_states[uid] = {"action": "reject_manual_reason", "oid": oid}

    # --- Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ---
    elif data == "adm_grp_status":
        if uid != ADMIN_ID: return
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats:
            mk.add(types.InlineKeyboardButton(f"ğŸ“‚ {c[1]}", callback_data=f"adm_list_grps_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª ÙˆØªØºÙŠÙŠØ± Ø­Ø§Ù„ØªÙ‡Ø§:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("adm_list_grps_"):
        cid = int(data.split("_")[3])
        grps = db_query("SELECT * FROM groups WHERE category_id=?", (cid,), fetch=True)
        mk = types.InlineKeyboardMarkup(row_width=1)
        for g in grps:
            active = g[4] if len(g) > 4 else 1
            status_icon = "âœ…" if active == 1 else "ğŸ”´"
            mk.add(types.InlineKeyboardButton(f"{status_icon} {g[2]}", callback_data=f"toggle_grp_{g[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_grp_status"))
        bot.edit_message_text("Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„ØªØ¹Ø·ÙŠÙ„Ù‡Ø§/ØªÙØ¹ÙŠÙ„Ù‡Ø§:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("toggle_grp_"):
        gid = int(data.split("_")[2])
        curr = db_query("SELECT is_active, category_id FROM groups WHERE id=?", (gid,), fetch=True)[0]
        new_val = 0 if curr[0] == 1 else 1
        db_query("UPDATE groups SET is_active=? WHERE id=?", (new_val, gid), commit=True)
        bot.answer_callback_query(call.id, "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©")
        handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': f'adm_list_grps_{curr[1]}', 'message': call.message, 'id': call.id}))

    # --- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ---
    elif data == "adm_stats":
        if uid != ADMIN_ID: return
        total_users = db_query("SELECT COUNT(*) FROM users", fetch=True)[0][0]
        total_spent = db_query("SELECT SUM(total_spent) FROM users", fetch=True)[0][0] or 0
        total_orders = db_query("SELECT COUNT(*) FROM orders", fetch=True)[0][0]
        dollar_rate = get_setting("dollar_rate")
        txt = f"ğŸ“Š **Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø¹Ø§Ù…Ø©**\n\nğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: **{total_users}**\nğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: **{total_spent} SYR**\nğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª: **{total_orders}**\nğŸ’² Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: **{dollar_rate}**"
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ‘¥ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", callback_data="adm_browse_users_0"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    elif data.startswith("adm_browse_users_"):
        if uid != ADMIN_ID: return
        page = int(data.split("_")[3])
        limit = 10
        offset = page * limit
        users = db_query(f"SELECT id, username, balance FROM users LIMIT {limit} OFFSET {offset}", fetch=True)
        total_users_count = db_query("SELECT COUNT(*) FROM users", fetch=True)[0][0]
        mk = types.InlineKeyboardMarkup(row_width=2)
        for u in users:
            name = u[1] if u[1] else "No Name"
            mk.add(types.InlineKeyboardButton(f"{name} | {u[2]}", callback_data=f"adm_user_info_{u[0]}"))
        nav_btns = []
        if page > 0: nav_btns.append(types.InlineKeyboardButton("â¬…ï¸ Ø§Ù„Ø³Ø§Ø¨Ù‚", callback_data=f"adm_browse_users_{page-1}"))
        if (offset + limit) < total_users_count: nav_btns.append(types.InlineKeyboardButton("Ø§Ù„ØªØ§Ù„ÙŠ â¡ï¸", callback_data=f"adm_browse_users_{page+1}"))
        if nav_btns: mk.add(*nav_btns)
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª", callback_data="adm_stats"))
        bot.edit_message_text(f"ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (ØµÙØ­Ø© {page+1}):", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("adm_user_info_"):
        if uid != ADMIN_ID: return
        tgt_id = int(data.split("_")[3])
        u = get_user(tgt_id)
        if not u: return
        last_orders = db_query("SELECT product_name, price_paid, date(created_at, 'unixepoch') FROM orders WHERE user_id=? ORDER BY created_at DESC LIMIT 5", (tgt_id,), fetch=True)
        orders_txt = "\nğŸ“¦ **Ø¢Ø®Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª:**\n"
        if not last_orders: orders_txt += "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª.\n"
        for o in last_orders: orders_txt += f"- {o[0]} ({o[1]} SYR)\n"
        info = f"ğŸ‘¤ **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…**\n\nğŸ†” ID: `{u[0]}`\nğŸ“› Username: @{u[1]}\nğŸ’° Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: **{u[2]}**\nğŸ’¸ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚: **{u[4]}**\nâ­ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: {u[3]}\nğŸ“… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…: {time.ctime(u[6])}\n----------------\n{orders_txt}"
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©", callback_data="adm_browse_users_0"))
        bot.edit_message_text(info, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    # --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø¹Ø¬Ù„Ø© ---
    elif data == "adm_raffle_manage":
        if uid != ADMIN_ID: return
        count = db_query("SELECT COUNT(*) FROM raffle_entries", fetch=True)[0][0]
        fee = get_setting("raffle_fee")
        prize = get_setting("raffle_prize")
        txt = f"ğŸ¡ **Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¹Ø¬Ù„Ø©**\n\nğŸ‘¥ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹: **{count}**\nğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: **{fee}**\nğŸ† Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©: **{prize}**"
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ² Ø³Ø­Ø¨ Ø§Ù„ÙØ§Ø¦Ø² Ø§Ù„Ø¢Ù†", callback_data="adm_raffle_draw"))
        mk.add(types.InlineKeyboardButton("âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¹Ø±", callback_data="adm_set_raf_fee"),
               types.InlineKeyboardButton("âœï¸ ØªØºÙŠÙŠØ± Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©", callback_data="adm_set_raf_prize"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)

    elif data == "adm_raffle_draw":
        entries = db_query("SELECT user_id FROM raffle_entries", fetch=True)
        count = len(entries)
        min_users = int(get_setting("raffle_min_users"))
        if count == 0:
            bot.answer_callback_query(call.id, "ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ†!", show_alert=True)
            return
        if count < min_users:
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton("Ù†Ø¹Ù…ØŒ ØªØ§Ø¨Ø¹ Ø§Ù„Ø³Ø­Ø¨", callback_data="adm_force_draw"),
                   types.InlineKeyboardButton("Ø¥Ù„ØºØ§Ø¡", callback_data="adm_raffle_manage"))
            bot.edit_message_text(f"âš ï¸ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ({count}) Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ ({min_users}).\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø³Ø­Ø¨ØŸ", uid, call.message.message_id, reply_markup=mk)
            return
        handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': 'adm_force_draw', 'message': call.message, 'id': call.id}))

    elif data == "adm_force_draw":
        entries = db_query("SELECT user_id FROM raffle_entries", fetch=True)
        if not entries: return
        winner_id = random.choice(entries)[0]
        prize = int(get_setting("raffle_prize"))
        db_query("UPDATE users SET balance = balance + ? WHERE id=?", (prize, winner_id), commit=True)
        db_query("DELETE FROM raffle_entries", commit=True)
        try: bot.send_message(winner_id, f"ğŸ‰ğŸ‰ **Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ!** ğŸ‰ğŸ‰\n\nÙ„Ù‚Ø¯ Ø±Ø¨Ø­Øª ÙÙŠ Ø§Ù„Ø³Ø­Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ!\nØªÙ… Ø¥Ø¶Ø§ÙØ© **{prize} SYR** Ø¥Ù„Ù‰ Ø±ØµÙŠØ¯Ùƒ.", parse_mode="Markdown")
        except: pass
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ù†Ø¬Ø§Ø­!")
        bot.edit_message_text(f"âœ… **ØªÙ… Ø§Ù„Ø³Ø­Ø¨!**\n\nØ§Ù„ÙØ§Ø¦Ø²: `{winner_id}`\nØ§Ù„Ø¬Ø§Ø¦Ø²Ø©: {prize}\nØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.", uid, call.message.message_id, parse_mode="Markdown", reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="adm_raffle_manage")))

    elif data == "adm_set_raf_fee":
        bot.send_message(uid, "Ø£Ø±Ø³Ù„ Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        admin_states[uid] = {"action": "set_raf_fee"}
    elif data == "adm_set_raf_prize":
        bot.send_message(uid, "Ø£Ø±Ø³Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø§Ø¦Ø²Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:")
        admin_states[uid] = {"action": "set_raf_prize"}

    # --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    elif data == "adm_products":
        if uid != ADMIN_ID: return
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© (ØªØµÙ†ÙŠÙ/Ù…Ø¬Ù…ÙˆØ¹Ø©/Ù…Ù†ØªØ¬)", callback_data="adm_add_menu"))
        mk.add(types.InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù (ØªØµÙ†ÙŠÙ/Ù…Ø¬Ù…ÙˆØ¹Ø©/Ù…Ù†ØªØ¬)", callback_data="adm_del_menu"))
        mk.add(types.InlineKeyboardButton("âœï¸ ØªØ¹Ø¯ÙŠÙ„ (ØªØµÙ†ÙŠÙ/Ù…Ø¬Ù…ÙˆØ¹Ø©/Ù…Ù†ØªØ¬)", callback_data="adm_edit_menu"))
        
        # [Ø¬Ø¯ÙŠØ¯] Ø²Ø± Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³ÙŠØ·
        if get_setting("enable_mediator") == "1":
            mk.add(types.InlineKeyboardButton("ğŸ”· Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù ÙˆØ³ÙŠØ·", callback_data="adm_med_menu"))
            
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©:", uid, call.message.message_id, reply_markup=mk)

    # [Ø¬Ø¯ÙŠØ¯] Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙˆØ³ÙŠØ·
    elif data == "adm_med_menu":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ· Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data="adm_add_med"))
        mk.add(types.InlineKeyboardButton("ğŸ—‘ Ø­Ø°Ù ÙˆØ³ÙŠØ·", callback_data="adm_del_med"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_products"))
        bot.edit_message_text("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØ³Ø·Ø§Ø¡:", uid, call.message.message_id, reply_markup=mk)

    elif data == "adm_add_med":
        grps = db_query("SELECT * FROM groups", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(g[2], callback_data=f"sel_grp_med_{g[0]}"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ· Ù„Ù‡Ø§:", uid, call.message.message_id, reply_markup=mk)
        
    elif data.startswith("sel_grp_med_"):
        gid = int(data.split("_")[3])
        bot.send_message(uid, "Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„ÙˆØ³ÙŠØ· (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ):")
        admin_states[uid] = {"action": "add_med_name", "gid": gid}

    elif data == "adm_del_med":
        # Ø¹Ø±Ø¶ Ø§Ù„ÙˆØ³Ø·Ø§Ø¡ Ù„Ù„Ø­Ø°Ù
        meds = db_query("SELECT * FROM mediators", fetch=True)
        mk = types.InlineKeyboardMarkup(row_width=1)
        for m in meds: mk.add(types.InlineKeyboardButton(f"âŒ {m[2]} (ID: {m[0]})", callback_data=f"exec_del_med_{m[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_med_menu"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ÙˆØ³ÙŠØ· Ù„Ø­Ø°ÙÙ‡:", uid, call.message.message_id, reply_markup=mk)

    elif data.startswith("exec_del_med_"):
        mid = int(data.split("_")[3])
        db_query("DELETE FROM mediators WHERE id=?", (mid,), commit=True)
        # ØªØµÙÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø±ØªØ¨Ø·
        db_query("UPDATE products SET mediator_id=0 WHERE mediator_id=?", (mid,), commit=True)
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ø­Ø°Ù")
        handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': 'adm_del_med', 'message': call.message, 'id': call.id}))

    elif data == "adm_add_menu":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("â• ØªØµÙ†ÙŠÙ", callback_data="adm_add_cat"), types.InlineKeyboardButton("â• Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data="adm_add_grp"), types.InlineKeyboardButton("â• Ù…Ù†ØªØ¬", callback_data="adm_add_prod"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_products"))
        bot.edit_message_text("Ø¥Ø¶Ø§ÙØ©:", uid, call.message.message_id, reply_markup=mk)
    elif data == "adm_del_menu":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ—‘ ØªØµÙ†ÙŠÙ", callback_data="adm_del_cat_list"), types.InlineKeyboardButton("ğŸ—‘ Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data="adm_del_grp_list"), types.InlineKeyboardButton("ğŸ—‘ Ù…Ù†ØªØ¬", callback_data="adm_del_prod_list"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_products"))
        bot.edit_message_text("Ø­Ø°Ù:", uid, call.message.message_id, reply_markup=mk)
    elif data == "adm_edit_menu":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("âœï¸ ØªØµÙ†ÙŠÙ", callback_data="adm_edit_cat_list"), types.InlineKeyboardButton("âœï¸ Ù…Ø¬Ù…ÙˆØ¹Ø©", callback_data="adm_edit_grp_list"), types.InlineKeyboardButton("âœï¸ Ù…Ù†ØªØ¬", callback_data="adm_edit_prod_list"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_products"))
        bot.edit_message_text("ØªØ¹Ø¯ÙŠÙ„:", uid, call.message.message_id, reply_markup=mk)

    # Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ (Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    elif data == "adm_add_cat":
        bot.send_message(uid, "Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„ØªØµÙ†ÙŠÙ:")
        admin_states[uid] = {"action": "add_cat"}
    elif data == "adm_add_grp":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats: mk.add(types.InlineKeyboardButton(c[1], callback_data=f"sel_cat_grp_{c[0]}"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("sel_cat_grp_"):
        bot.send_message(uid, "Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:")
        admin_states[uid] = {"action": "add_grp_name", "cid": int(data.split("_")[3])}
    
    elif data == "adm_add_prod":
        grps = db_query("SELECT * FROM groups", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(g[2], callback_data=f"sel_grp_prod_{g[0]}"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)
    
    elif data.startswith("sel_grp_prod_"):
        gid = int(data.split("_")[3])
        # [Ø¬Ø¯ÙŠØ¯] Ø¥Ø°Ø§ Ø§Ù„ÙˆØ³ÙŠØ· Ù…ÙØ¹Ù„ØŒ Ù†Ø³Ø£Ù„ Ø¹Ù† Ø§Ù„ÙˆØ³ÙŠØ· Ø£ÙˆÙ„Ø§Ù‹
        if get_setting("enable_mediator") == "1":
            meds = db_query("SELECT * FROM mediators WHERE group_id=?", (gid,), fetch=True)
            if meds:
                mk = types.InlineKeyboardMarkup()
                mk.add(types.InlineKeyboardButton("Ø¨Ø¯ÙˆÙ† ÙˆØ³ÙŠØ·", callback_data=f"sel_med_prod_0_{gid}"))
                for m in meds: mk.add(types.InlineKeyboardButton(m[2], callback_data=f"sel_med_prod_{m[0]}_{gid}"))
                bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ÙˆØ³ÙŠØ· (Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ):", uid, call.message.message_id, reply_markup=mk)
                return
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙˆØ³Ø·Ø§Ø¡ Ø£Ùˆ Ø§Ù„Ù…ÙŠØ²Ø© Ù…Ø¹Ø·Ù„Ø©
        handle_callback(type('obj', (object,), {'from_user': call.from_user, 'data': f'sel_med_prod_0_{gid}', 'message': call.message, 'id': call.id}))

    elif data.startswith("sel_med_prod_"):
        parts = data.split("_")
        med_id = int(parts[3])
        gid = int(parts[4])
        
        bot.send_message(uid, "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:")
        admin_states[uid] = {"action": "add_prod_name", "gid": gid, "med_id": med_id}
    
    # Ø¨Ù‚ÙŠØ© Ø§Ù„Ø­Ø°Ù ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„
    elif data == "adm_del_cat_list":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats: mk.add(types.InlineKeyboardButton(f"âŒ {c[1]}", callback_data=f"exec_del_cat_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_del_menu"))
        bot.edit_message_text("Ø­Ø°Ù ØªØµÙ†ÙŠÙ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("exec_del_cat_"):
        cid = int(data.split("_")[3])
        grps = db_query("SELECT id FROM groups WHERE category_id=?", (cid,), fetch=True)
        for g in grps: db_query("DELETE FROM products WHERE group_id=?", (g[0],), commit=True)
        db_query("DELETE FROM groups WHERE category_id=?", (cid,), commit=True)
        db_query("DELETE FROM categories WHERE id=?", (cid,), commit=True)
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ø­Ø°Ù")
        handle_callback(call)
    elif data == "adm_del_grp_list":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats: mk.add(types.InlineKeyboardButton(f"ğŸ“‚ {c[1]}", callback_data=f"list_del_grp_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_del_menu"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("list_del_grp_"):
        cid = int(data.split("_")[3])
        grps = db_query("SELECT * FROM groups WHERE category_id=?", (cid,), fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(f"âŒ {g[2]}", callback_data=f"exec_del_grp_{g[0]}"))
        bot.edit_message_text("Ø­Ø°Ù Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("exec_del_grp_"):
        gid = int(data.split("_")[3])
        db_query("DELETE FROM products WHERE group_id=?", (gid,), commit=True)
        db_query("DELETE FROM groups WHERE id=?", (gid,), commit=True)
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ø­Ø°Ù")
        bot.edit_message_text("ØªÙ… Ø§Ù„Ø­Ø°Ù", uid, call.message.message_id, reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="adm_products")))
    elif data == "adm_del_prod_list":
        grps = db_query("SELECT * FROM groups", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(f"ğŸ® {g[2]}", callback_data=f"list_del_prod_{g[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_del_menu"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("list_del_prod_"):
        gid = int(data.split("_")[3])
        prods = db_query("SELECT * FROM products WHERE group_id=?", (gid,), fetch=True)
        mk = types.InlineKeyboardMarkup()
        for p in prods: mk.add(types.InlineKeyboardButton(f"âŒ {p[2]}", callback_data=f"exec_del_prod_{p[0]}"))
        bot.edit_message_text("Ø­Ø°Ù Ù…Ù†ØªØ¬:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("exec_del_prod_"):
        pid = int(data.split("_")[3])
        db_query("DELETE FROM products WHERE id=?", (pid,), commit=True)
        bot.answer_callback_query(call.id, "ØªÙ… Ø§Ù„Ø­Ø°Ù")
        bot.edit_message_text("ØªÙ… Ø§Ù„Ø­Ø°Ù", uid, call.message.message_id, reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="adm_products")))

    # Edit Handlers
    elif data == "adm_edit_cat_list":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats: mk.add(types.InlineKeyboardButton(f"âœï¸ {c[1]}", callback_data=f"do_edit_cat_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_edit_menu"))
        bot.edit_message_text("ØªØ¹Ø¯ÙŠÙ„ ØªØµÙ†ÙŠÙ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("do_edit_cat_"):
        bot.send_message(uid, "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        admin_states[uid] = {"action": "edit_cat_name", "id": int(data.split("_")[3])}
    elif data == "adm_edit_grp_list":
        cats = db_query("SELECT * FROM categories", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for c in cats: mk.add(types.InlineKeyboardButton(f"ğŸ“‚ {c[1]}", callback_data=f"list_edit_grp_{c[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_edit_menu"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("list_edit_grp_"):
        cid = int(data.split("_")[3])
        grps = db_query("SELECT * FROM groups WHERE category_id=?", (cid,), fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(f"âœï¸ {g[2]}", callback_data=f"sel_edit_grp_{g[0]}"))
        bot.edit_message_text("ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("sel_edit_grp_"):
        gid = int(data.split("_")[3])
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("Ø§Ù„Ø§Ø³Ù…", callback_data=f"do_edit_grp_name_{gid}"), types.InlineKeyboardButton("Ø§Ù„ØµÙˆØ±Ø©", callback_data=f"do_edit_grp_img_{gid}"))
        bot.edit_message_text("Ù…Ø§Ø°Ø§ ØªØ¹Ø¯Ù„ØŸ", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("do_edit_grp_name_"):
        bot.send_message(uid, "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        admin_states[uid] = {"action": "edit_grp_name", "id": int(data.split("_")[4])}
    elif data.startswith("do_edit_grp_img_"):
        bot.send_message(uid, "Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø£Ùˆ no):")
        admin_states[uid] = {"action": "edit_grp_img", "id": int(data.split("_")[4])}
    elif data == "adm_edit_prod_list":
        grps = db_query("SELECT * FROM groups", fetch=True)
        mk = types.InlineKeyboardMarkup()
        for g in grps: mk.add(types.InlineKeyboardButton(f"ğŸ® {g[2]}", callback_data=f"list_edit_prod_{g[0]}"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="adm_edit_menu"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("list_edit_prod_"):
        gid = int(data.split("_")[3])
        prods = db_query("SELECT * FROM products WHERE group_id=?", (gid,), fetch=True)
        mk = types.InlineKeyboardMarkup()
        for p in prods: mk.add(types.InlineKeyboardButton(f"âœï¸ {p[2]}", callback_data=f"sel_edit_prod_{p[0]}"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("sel_edit_prod_"):
        pid = int(data.split("_")[3])
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("Ø§Ù„Ø§Ø³Ù…", callback_data=f"do_edit_prod_name_{pid}"), types.InlineKeyboardButton("Ø§Ù„Ø³Ø¹Ø± SYR", callback_data=f"do_edit_prod_price_{pid}"))
        mk.add(types.InlineKeyboardButton("Ø§Ù„Ø³Ø¹Ø± USD", callback_data=f"do_edit_prod_usd_{pid}"), types.InlineKeyboardButton("API ID", callback_data=f"do_edit_prod_api_{pid}"))
        bot.edit_message_text("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("do_edit_prod_name_"):
        bot.send_message(uid, "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:")
        admin_states[uid] = {"action": "edit_prod_name", "id": int(data.split("_")[4])}
    elif data.startswith("do_edit_prod_price_"):
        bot.send_message(uid, "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø§Ù„Ù„ÙŠØ±Ø© SYR):")
        admin_states[uid] = {"action": "edit_prod_price", "id": int(data.split("_")[4])}
    elif data.startswith("do_edit_prod_usd_"):
        bot.send_message(uid, "Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± USD) - Ø£Ø±Ø³Ù„ 0 Ù„Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±:")
        admin_states[uid] = {"action": "edit_prod_usd", "id": int(data.split("_")[4])}
    elif data.startswith("do_edit_prod_api_"):
        bot.send_message(uid, "API ID Ø§Ù„Ø¬Ø¯ÙŠØ¯ (0 Ù„ÙŠØ¯ÙˆÙŠ):")
        admin_states[uid] = {"action": "edit_prod_api", "id": int(data.split("_")[4])}

    # --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ø²Ø± Ø³Ø±ÙŠØ¹) ---
    elif data == "adm_quick_level":
        if uid != ADMIN_ID: return
        bot.send_message(uid, "ğŸ… **ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø±ÙŠØ¹**\nØ£Ø±Ø³Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ (ID) Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØªØºÙŠÙŠØ± Ù…Ø³ØªÙˆØ§Ù‡ ÙÙˆØ±Ø§Ù‹:", parse_mode="Markdown")
        admin_states[uid] = {"action": "adm_quick_lvl_id"}

    elif data == "adm_manage_balance":
        if uid != ADMIN_ID: return
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯", callback_data="adm_bal_add"),
               types.InlineKeyboardButton("â– Ø®ØµÙ… Ø±ØµÙŠØ¯", callback_data="adm_bal_deduct"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø±ØµØ¯Ø©:", uid, call.message.message_id, reply_markup=mk)

    elif data == "adm_bal_add":
        bot.send_message(uid, "ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:")
        admin_states[uid] = {"action": "adm_bal_add_id"}
    elif data == "adm_bal_deduct":
        bot.send_message(uid, "ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:")
        admin_states[uid] = {"action": "adm_bal_deduct_id"}

    # --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¯ÙˆØ§Øª + [Ø§Ù„Ø¬Ø¯ÙŠØ¯] ---
    elif data == "adm_broadcast":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("Ù†Øµ", callback_data="brd_text"), types.InlineKeyboardButton("ØµÙˆØ±Ø©", callback_data="brd_photo"))
        bot.edit_message_text("Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:", uid, call.message.message_id, reply_markup=mk)
    elif data == "brd_text":
        bot.send_message(uid, "Ø§Ù„Ù†Øµ:")
        admin_states[uid] = {"action": "broadcast_text"}
    elif data == "brd_photo":
        bot.send_message(uid, "Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„ÙƒØ§Ø¨Ø´Ù†:")
        admin_states[uid] = {"action": "broadcast_photo"}
    
    # [Ø¬Ø¯ÙŠØ¯] Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
    elif data == "adm_set_rate":
        current = get_setting("dollar_rate")
        bot.send_message(uid, f"ğŸ’² Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: **{current}**\nØ£Ø±Ø³Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ÙŠØ¯Ø¹Ù… Ø§Ù„ÙÙˆØ§ØµÙ„ØŒ Ù…Ø«Ø§Ù„: 15200.5):", parse_mode="Markdown")
        admin_states[uid] = {"action": "set_dollar_rate"}

    # [Ø¬Ø¯ÙŠØ¯] ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
    elif data == "adm_server_help":
        msg = """
â˜ï¸ **ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø±ÙØ¹ Ø§Ù„Ø¨ÙˆØª Ø¹Ù„Ù‰ Ø³ÙŠØ±ÙØ± (VPS/Ubuntu):**

1. Ø§Ø­Ø¬Ø² Ø³ÙŠØ±ÙØ± (Ubuntu 20.04+).
2. Ø§ØªØµÙ„ Ø¹Ø¨Ø± SSH.
3. Ù†ÙØ° Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù„ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ¦Ø©:
`sudo apt update && sudo apt install python3-pip screen -y`
`pip3 install pyTelegramBotAPI requests`

4. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø¨ÙˆØª `bot.py` ÙˆÙ…Ù„Ù Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¥Ù† ÙˆØ¬Ø¯) Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±.
5. Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©:
`screen -S bot`
`python3 bot.py`
Ø§Ø¶ØºØ· `Ctrl+A` Ø«Ù… `D` Ù„Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ø¹ Ø¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„.

âš ï¸ **Ù„Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©:** ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ‚Ø¹ Render Ø£Ùˆ Railway Ù…Ø¹ Ù…Ù„Ù `requirements.txt` ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰:
`pyTelegramBotAPI`
`requests`
        """
        bot.edit_message_text(msg, uid, call.message.message_id, parse_mode="Markdown", reply_markup=types.InlineKeyboardMarkup().add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="admin_panel")))

    # [Ø¬Ø¯ÙŠØ¯] Ø§Ù„ØªØ¨Ø¯ÙŠÙ„Ø§Øª (Toggles)
    elif data == "adm_toggle_mediator":
        curr = get_setting("enable_mediator")
        new_val = "1" if curr == "0" else "0"
        set_setting("enable_mediator", new_val)
        status = "âœ… Ù…ÙØ¹Ù„" if new_val=="1" else "âŒ Ù…Ø¹Ø·Ù„"
        bot.answer_callback_query(call.id, f"Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³ÙŠØ·: {status}")
        bot.edit_message_text(f"Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ³ÙŠØ·: {status}", uid, call.message.message_id, reply_markup=admin_menu())

    elif data == "adm_toggle_user_cur":
        curr = get_setting("enable_user_currency")
        new_val = "1" if curr == "0" else "0"
        set_setting("enable_user_currency", new_val)
        status = "âœ… Ù…ÙØ¹Ù„" if new_val=="1" else "âŒ Ù…Ø¹Ø·Ù„"
        bot.answer_callback_query(call.id, f"ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ù„Ø²Ø¨Ø§Ø¦Ù†: {status}")
        bot.edit_message_text(f"ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„Ø©: {status}", uid, call.message.message_id, reply_markup=admin_menu())

    elif data == "adm_maintenance":
        status = get_setting("maintenance")
        mk = types.InlineKeyboardMarkup()
        if status == "0": mk.add(types.InlineKeyboardButton("ğŸ›‘ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙŠØ§Ù†Ø©", callback_data="set_maint_on"))
        else: mk.add(types.InlineKeyboardButton("âœ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙŠØ§Ù†Ø©", callback_data="set_maint_off"))
        mk.add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(f"Ø§Ù„ØµÙŠØ§Ù†Ø©: {'Ù…ÙØ¹Ù„Ø©' if status=='1' else 'Ù…ØªÙˆÙ‚ÙØ©'}", uid, call.message.message_id, reply_markup=mk)
    elif data == "set_maint_on":
        bot.send_message(uid, "Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙˆÙ‚Ù:")
        admin_states[uid] = {"action": "maint_on_msg"}
    elif data == "set_maint_off":
        bot.send_message(uid, "Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø©:")
        admin_states[uid] = {"action": "maint_off_msg"}

    elif data == "adm_texts":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("/start", callback_data="edit_txt_start"), types.InlineKeyboardButton("Ø¯Ø¹Ù…", callback_data="edit_txt_support"), types.InlineKeyboardButton("Ø´Ø±ÙˆØ·", callback_data="edit_txt_terms"))
        mk.add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù†Øµ:", uid, call.message.message_id, reply_markup=mk)
    elif data.startswith("edit_txt_"):
        key = {"start": "start_msg", "support": "support_msg", "terms": "terms_msg"}[data.split("_")[2]]
        bot.send_message(uid, f"Ø§Ù„Ù†Øµ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ {key}:")
        admin_states[uid] = {"action": "save_text", "key": key}

    elif data == "adm_methods":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ©", callback_data="adm_add_method"))
        for m in db_query("SELECT * FROM payment_methods", fetch=True): mk.add(types.InlineKeyboardButton(f"ğŸ—‘ {m[1]}", callback_data=f"del_meth_{m[0]}"))
        mk.add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹:", uid, call.message.message_id, reply_markup=mk)
    elif data == "adm_add_method":
        bot.send_message(uid, "Ø§Ù„Ø§Ø³Ù…:")
        admin_states[uid] = {"action": "add_meth_name"}
    elif data.startswith("del_meth_"):
        db_query("DELETE FROM payment_methods WHERE id=?", (int(data.split("_")[2]),), commit=True)
        bot.answer_callback_query(call.id, "Ø­Ø°Ù")
        handle_callback(call)

    # --- Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© ---
    elif data == "adm_transactions":
        trans = db_query("SELECT * FROM transactions WHERE status='pending'", fetch=True)
        if not trans:
            bot.answer_callback_query(call.id, "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª", show_alert=True)
            return
        for t in trans:
            uname = get_user(t[1])[1]
            txt = f"ğŸ“ {t[2]}\nğŸ‘¤ @{uname}\nğŸ’° {t[3]}\nğŸ’³ {t[4]}\nğŸ“… {t[8]}"
            if t[2]=="withdraw": txt+=f"\nØ±Ù‚Ù…: `{t[5]}`"
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton("âœ…", callback_data=f"acc_trans_{t[0]}"), types.InlineKeyboardButton("âŒ", callback_data=f"rej_trans_{t[0]}"))
            if t[6]: 
                try: bot.send_photo(uid, t[6], caption=txt, reply_markup=mk)
                except: bot.send_message(uid, txt, reply_markup=mk)
            else: bot.send_message(uid, txt, reply_markup=mk)

    elif data.startswith("acc_trans_"):
        tid = int(data.split("_")[2])
        t = db_query("SELECT * FROM transactions WHERE id=?", (tid,), fetch=True)[0]
        if t[2] == "deposit":
            db_query("UPDATE users SET balance = balance + ? WHERE id=?", (t[3], t[1]), commit=True)
            try: bot.send_message(t[1], f"âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¥ÙŠØ¯Ø§Ø¹Ùƒ: {t[3]}")
            except: pass
        else:
            try: bot.send_message(t[1], "âœ… ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨")
            except: pass
        db_query("UPDATE transactions SET status='approved' WHERE id=?", (tid,), commit=True)
        bot.delete_message(uid, call.message.message_id)

    elif data.startswith("rej_trans_"):
        tid = int(data.split("_")[2])
        t = db_query("SELECT * FROM transactions WHERE id=?", (tid,), fetch=True)[0]
        if t[2] == "withdraw":
            total = int(t[3] * (1 + WITHDRAW_FEE_PERCENT/100))
            db_query("UPDATE users SET balance = balance + ? WHERE id=?", (total, t[1]), commit=True)
        try: bot.send_message(t[1], f"âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ {t[2]}")
        except: pass
        db_query("UPDATE transactions SET status='rejected' WHERE id=?", (tid,), commit=True)
        bot.delete_message(uid, call.message.message_id)

    # --- Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
    elif data == "adm_users":
        mk = types.InlineKeyboardMarkup()
        mk.add(types.InlineKeyboardButton("ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¢ÙŠØ¯ÙŠ", callback_data="adm_search_user"))
        mk.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text("Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", uid, call.message.message_id, reply_markup=mk)
    elif data == "adm_search_user":
        bot.send_message(uid, "ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:")
        admin_states[uid] = {"action": "search_user"}

    # --- Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª ---
    elif data == "adm_levels":
        lvls = db_query("SELECT * FROM levels ORDER BY level_id ASC", fetch=True)
        txt = "ğŸ’ **Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„ÙˆØµÙˆÙ„ - Ø®ØµÙ…):**\n"
        mk = types.InlineKeyboardMarkup()
        for l in lvls:
            txt += f"L{l[0]} {l[1]}: Ø®ØµÙ… {l[2]}% | Ù…Ø·Ù„ÙˆØ¨ Ø¥Ù†ÙØ§Ù‚ {l[3]}\n"
            mk.add(types.InlineKeyboardButton(f"ØªØ¹Ø¯ÙŠÙ„ L{l[0]}", callback_data=f"edit_lvl_{l[0]}"))
        mk.add(types.InlineKeyboardButton("Ø±Ø¬ÙˆØ¹", callback_data="admin_panel"))
        bot.edit_message_text(txt, uid, call.message.message_id, parse_mode="Markdown", reply_markup=mk)
    elif data.startswith("edit_lvl_"):
        lid = int(data.split("_")[2])
        bot.send_message(uid, f"ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙˆÙ‰ {lid}\nØ£Ø±Ø³Ù„: `Ø§Ù„Ø§Ø³Ù…-Ø§Ù„Ø®ØµÙ…-Ø§Ù„Ø§Ù†ÙØ§Ù‚_Ø§Ù„Ù…Ø·Ù„ÙˆØ¨`\nÙ…Ø«Ø§Ù„: `Ù…Ø§Ø³ÙŠ-12-300000`", parse_mode="Markdown")
        admin_states[uid] = {"action": "update_level", "lid": lid}

# ================= Ø§Ù„ØµÙˆØ± =================
@bot.message_handler(content_types=['photo'])
def handle_photo(message):
    uid = message.from_user.id
    if uid in admin_states:
        st = admin_states[uid]
        if st["action"] == "dep_wait_proof":
            fid = message.photo[-1].file_id
            db_query("INSERT INTO transactions (user_id, type, amount, method_name, proof_image, status, date) VALUES (?,?,?,?,?,?,?)",
                     (uid, "deposit", st["amount"], st["method_name"], fid, "pending", int(time.time())), commit=True)
            bot.send_message(uid, "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±.")
            bot.send_message(ADMIN_ID, f"ğŸ”” Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯: {st['amount']}")
            del admin_states[uid]
        elif st["action"] == "broadcast_photo":
            c = broadcast_message(message.caption or "", message.photo[-1].file_id)
            bot.send_message(uid, f"âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ {c}")
            del admin_states[uid]

# ================= Ø§Ù„Ù†ØµÙˆØµ =================
@bot.message_handler(content_types=['text'])
def handle_text(message):
    uid = message.from_user.id
    txt = message.text.strip()
    
    if uid in admin_states:
        st = admin_states[uid]
        
        # --- Ø§Ù„Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (Ù…Ù†ØªØ¬ Ù„ÙŠØ³ ÙƒÙ…ÙŠØ§Øª) ---
        if st["action"] == "wait_player_id":
            prod = db_query("SELECT * FROM products WHERE id=?", (st["prod_id"],), fetch=True)[0]
            # Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø­Ø³ÙˆØ¨ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙˆØ§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ø§Ù„Ù€ state
            price = st["price"]
            cost = prod[6] if len(prod) > 6 else 0
            
            db_query("UPDATE users SET balance = balance - ?, total_spent = total_spent + ? WHERE id=?", (price, price, uid), commit=True)
            seq_id = str(get_next_order_id())
            bot.send_message(uid, f"âœ… **ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!**\nğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: `{seq_id}`\nâ³ Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...", parse_mode="Markdown")
            
            check_auto_promotion(uid, get_user(uid)[4], get_user(uid)[3])
            success, api_msg = execute_big_boss_order(uid, txt, prod[4])
            
            if api_msg == "MANUAL_PROCESSING":
                db_query("INSERT INTO orders (order_id, user_id, product_name, price_paid, api_status, created_at, status, quantity, cost_at_purchase) VALUES (?,?,?,?,?,?,?,1,?)", 
                         (seq_id, uid, prod[2], price, "Manual", int(time.time()), "pending_manual", cost), commit=True)
                bot.send_message(ADMIN_ID, f"ğŸ”” **Ø·Ù„Ø¨ ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯ #{seq_id}**\nğŸ‘¤ @{message.from_user.username}\nğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: {prod[2]}\nğŸ†” Ø§Ù„Ø¢ÙŠØ¯ÙŠ: `{txt}`\nğŸ’° Ø§Ù„Ø³Ø¹Ø±: {price}")
            else:
                status = "completed" if success else "failed"
                db_query("INSERT INTO orders (order_id, user_id, product_name, price_paid, api_status, created_at, status, quantity, cost_at_purchase) VALUES (?,?,?,?,?,?,?,1,?)", 
                         (seq_id, uid, prod[2], price, api_msg, int(time.time()), status, cost), commit=True)
                if success:
                    bot.send_message(uid, f"âœ… **ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ #{seq_id}**\n{api_msg}")
                    bot.send_message(ADMIN_ID, f"âœ… Ø·Ù„Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø§Ø¬Ø­ #{seq_id}\nğŸ“¦ {prod[2]}")
                else:
                    db_query("UPDATE users SET balance = balance + ?, total_spent = total_spent - ? WHERE id=?", (price, price, uid), commit=True)
                    bot.send_message(uid, f"âš ï¸ **ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ #{seq_id}**\nØ§Ù„Ø³Ø¨Ø¨: {api_msg}\nğŸ’° ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯.")
            del admin_states[uid]

        # --- [Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©] Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ…ÙŠØ§Øª ---
        elif st["action"] == "wait_qty_input":
            if not txt.isdigit(): return bot.send_message(uid, "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù„Ù„ÙƒÙ…ÙŠØ©:")
            qty = int(txt)
            min_qty = st.get("min_qty", 1)
            if qty < min_qty: return bot.send_message(uid, f"âš ï¸ Ø£Ù‚Ù„ ÙƒÙ…ÙŠØ© Ù…Ø³Ù…ÙˆØ­Ø©: {min_qty}")
            
            prod_info = db_query("SELECT * FROM products WHERE id=?", (st["prod_id"],), fetch=True)[0]
            
            # [Ø¬Ø¯ÙŠØ¯] Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            unit_price_real = get_product_real_price_syr(prod_info)
            base_total = unit_price_real * qty
            
            final_total = calculate_final_price(base_total, get_user(uid)[3])
            
            if get_user(uid)[2] < final_total:
                bot.send_message(uid, f"ğŸš« Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§Ù!\nØ§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù€ {qty} Ù‚Ø·Ø¹Ø©: **{final_total} SYR**")
                del admin_states[uid]
                return
            
            st["qty"] = qty
            st["final_total"] = final_total
            st["action"] = "wait_id_qty_mode"
            bot.send_message(uid, f"âœ… Ø§Ù„ÙƒÙ…ÙŠØ©: {qty}\nğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: **{final_total} SYR**\n\nğŸ†” **Ø§Ù„Ø¢Ù† Ø£Ø±Ø³Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ (ID):**", parse_mode="Markdown")

        elif st["action"] == "wait_id_qty_mode":
            player_id = txt
            qty = st["qty"]
            price = st["final_total"]
            prod_info = db_query("SELECT * FROM products WHERE id=?", (st["prod_id"],), fetch=True)[0]
            cost_unit = prod_info[6] if len(prod_info) > 6 else 0
            total_cost = cost_unit * qty
            
            db_query("UPDATE users SET balance = balance - ?, total_spent = total_spent + ? WHERE id=?", (price, price, uid), commit=True)
            seq_id = str(get_next_order_id())
            bot.send_message(uid, f"âœ… **ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨!**\nğŸ”¢ #{seq_id}\nâ³ Ù…Ø¹Ø§Ù„Ø¬Ø©...", parse_mode="Markdown")
            
            check_auto_promotion(uid, get_user(uid)[4], get_user(uid)[3])
            success, api_msg = execute_big_boss_order(uid, player_id, prod_info[4], qty)
            prod_name_qty = f"{prod_info[2]} (x{qty})"
            
            if api_msg == "MANUAL_PROCESSING":
                db_query("INSERT INTO orders (order_id, user_id, product_name, price_paid, api_status, created_at, status, quantity, cost_at_purchase) VALUES (?,?,?,?,?,?,?,?,?)", 
                         (seq_id, uid, prod_name_qty, price, "Manual", int(time.time()), "pending_manual", qty, total_cost), commit=True)
                bot.send_message(ADMIN_ID, f"ğŸ”” **Ø·Ù„Ø¨ ÙƒÙ…ÙŠØ§Øª ÙŠØ¯ÙˆÙŠ #{seq_id}**\nğŸ‘¤ @{message.from_user.username}\nğŸ“¦ {prod_name_qty}\nğŸ†” `{player_id}`")
            else:
                status = "completed" if success else "failed"
                db_query("INSERT INTO orders (order_id, user_id, product_name, price_paid, api_status, created_at, status, quantity, cost_at_purchase) VALUES (?,?,?,?,?,?,?,?,?)", 
                         (seq_id, uid, prod_name_qty, price, api_msg, int(time.time()), status, qty, total_cost), commit=True)
                if success: 
                    bot.send_message(uid, f"âœ… **ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ #{seq_id}**\n{api_msg}")
                    bot.send_message(ADMIN_ID, f"âœ… Ø·Ù„Ø¨ ÙƒÙ…ÙŠØ§Øª Ù†Ø§Ø¬Ø­ #{seq_id}")
                else: 
                    db_query("UPDATE users SET balance = balance + ?, total_spent = total_spent - ? WHERE id=?", (price, price, uid), commit=True)
                    bot.send_message(uid, f"âš ï¸ **ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨ #{seq_id}**\n{api_msg}\nğŸ’° ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯.")
            del admin_states[uid]

        # --- Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‚ ---
        elif st["action"] == "reject_manual_reason":
            oid = st["oid"]
            o = db_query("SELECT * FROM orders WHERE order_id=?", (oid,), fetch=True)[0]
            db_query("UPDATE users SET balance = balance + ?, total_spent = total_spent - ? WHERE id=?", (o[3], o[3], o[1]), commit=True)
            db_query("UPDATE orders SET status='refunded' WHERE order_id=?", (oid,), commit=True)
            try: bot.send_message(o[1], f"âŒ **ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ #{oid}**\nØ§Ù„Ø³Ø¨Ø¨: {txt}\nğŸ’° ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯.")
            except: pass
            bot.send_message(uid, "âœ… ØªÙ… Ø§Ù„Ø±ÙØ¶ ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯.")
            del admin_states[uid]

        # Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        elif st["action"] == "dep_wait_amount":
            if not txt.isdigit(): return
            st["amount"] = int(txt)
            st["action"] = "dep_wait_proof"
            bot.send_message(uid, "ğŸ“¸ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„:")
        elif st["action"] == "wd_wait_amount":
            if not txt.isdigit(): return
            amt = int(txt)
            total = int(amt * (1 + WITHDRAW_FEE_PERCENT/100))
            if get_user(uid)[2] < total:
                bot.send_message(uid, f"âŒ Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù. Ù…Ø·Ù„ÙˆØ¨: {total}")
                del admin_states[uid]
                return
            st["amount"] = amt
            st["total"] = total
            st["action"] = "wd_wait_num"
            bot.send_message(uid, f"Ø³ÙŠØ®ØµÙ… {total}. Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:")
        elif st["action"] == "wd_wait_num":
            db_query("UPDATE users SET balance = balance - ? WHERE id=?", (st["total"], uid), commit=True)
            db_query("INSERT INTO transactions (user_id, type, amount, method_name, user_account, status, date) VALUES (?,?,?,?,?,?,?)",
                     (uid, "withdraw", st["amount"], st["method_name"], txt, "pending", int(time.time())), commit=True)
            bot.send_message(uid, "âœ… ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨")
            bot.send_message(ADMIN_ID, f"ğŸ”” Ø³Ø­Ø¨: {st['amount']}")
            del admin_states[uid]

        # Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        elif st["action"] == "edit_cat_name":
            db_query("UPDATE categories SET name=? WHERE id=?", (txt, st["id"]), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "edit_grp_name":
            db_query("UPDATE groups SET name=? WHERE id=?", (txt, st["id"]), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "edit_grp_img":
            img = txt if txt.lower() != 'no' else None
            db_query("UPDATE groups SET image_url=? WHERE id=?", (img, st["id"]), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "edit_prod_name":
            db_query("UPDATE products SET name=? WHERE id=?", (txt, st["id"]), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "edit_prod_price":
            try:
                price = float(txt)
                db_query("UPDATE products SET price=? WHERE id=?", (price, st["id"]), commit=True)
                bot.send_message(uid, "âœ… ØªÙ…")
                del admin_states[uid]
            except ValueError:
                bot.send_message(uid, "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­")
        # [Ø¬Ø¯ÙŠØ¯] ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±
        elif st["action"] == "edit_prod_usd":
            try:
                price = float(txt)
                db_query("UPDATE products SET price_usd=? WHERE id=?", (price, st["id"]), commit=True)
                bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±")
                del admin_states[uid]
            except ValueError:
                bot.send_message(uid, "âŒ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­")

        elif st["action"] == "edit_prod_api":
            db_query("UPDATE products SET api_product_id=? WHERE id=?", (txt, st["id"]), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]

        # Ø¥Ø¶Ø§ÙØ©
        elif st["action"] == "add_cat":
            db_query("INSERT INTO categories (name) VALUES (?)", (txt,), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "add_grp_name":
            st["grp_name"] = txt
            st["action"] = "add_grp_img"
            bot.send_message(uid, "Ø§Ù„ØµÙˆØ±Ø© (Ø£Ùˆ no):")
        elif st["action"] == "add_grp_img":
            img = txt if txt.lower() != 'no' else None
            db_query("INSERT INTO groups (category_id, name, image_url) VALUES (?,?,?)", (st["cid"], st["grp_name"], img), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        
        # [Ø¬Ø¯ÙŠØ¯] Ø¥Ø¶Ø§ÙØ© ÙˆØ³ÙŠØ·
        elif st["action"] == "add_med_name":
            db_query("INSERT INTO mediators (group_id, name) VALUES (?, ?)", (st["gid"], txt), commit=True)
            bot.send_message(uid, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ³ÙŠØ·")
            del admin_states[uid]

        # Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ (Ø§Ù„Ø³Ù„Ø³Ù„Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± ÙˆØ§Ù„ÙˆØ³ÙŠØ·)
        elif st["action"] == "add_prod_name":
            st["prod_name"] = txt
            st["action"] = "add_prod_price_choice"
            mk = types.ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
            mk.add("SYR (Ù„ÙŠØ±Ø© Ø³ÙˆØ±ÙŠØ©)", "USD (Ø¯ÙˆÙ„Ø§Ø±)")
            bot.send_message(uid, "Ø¨Ø£ÙŠ Ø¹Ù…Ù„Ø© ØªØ±ÙŠØ¯ ØªØ³Ø¹ÙŠØ± Ø§Ù„Ù…Ù†ØªØ¬ØŸ", reply_markup=mk)

        elif st["action"] == "add_prod_price_choice":
            if txt == "USD (Ø¯ÙˆÙ„Ø§Ø±)":
                st["is_usd_pricing"] = True
                bot.send_message(uid, "ğŸ’° Ø£Ø±Ø³Ù„ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¯ÙˆÙ„Ø§Ø± (Ù…Ø«Ø§Ù„: 1.5):", reply_markup=types.ReplyKeyboardRemove())
            else:
                st["is_usd_pricing"] = False
                bot.send_message(uid, "ğŸ’° Ø£Ø±Ø³Ù„ Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ù„ÙŠØ±Ø© (Ù…Ø«Ø§Ù„: 15000):", reply_markup=types.ReplyKeyboardRemove())
            st["action"] = "add_prod_price_val"

        elif st["action"] == "add_prod_price_val":
            try:
                val = float(txt)
                if st["is_usd_pricing"]:
                    st["prod_usd"] = val
                    st["prod_price"] = 0 # Dummy value for SYR column if using USD
                else:
                    st["prod_usd"] = 0
                    st["prod_price"] = val
                
                st["action"] = "add_prod_cost"
                bot.send_message(uid, "ğŸ“‰ **Ø³Ø¹Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ø¹Ù„ÙŠÙƒ** (Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ - Ø¨Ø§Ù„Ù„ÙŠØ±Ø©):")
            except ValueError:
                bot.send_message(uid, "âš ï¸ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹:")

        elif st["action"] == "add_prod_cost":
            try:
                st["cost_price"] = float(txt)
                st["action"] = "add_prod_api"
                bot.send_message(uid, "API ID (0 Ù„ÙŠØ¯ÙˆÙŠ):")
            except ValueError:
                bot.send_message(uid, "âš ï¸ Ø£Ø±Ø³Ù„ Ø±Ù‚Ù…Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹:")

        elif st["action"] == "add_prod_api":
            st["prod_api"] = txt
            st["action"] = "add_prod_is_qty"
            mk = types.ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
            mk.add("Ù†Ø¹Ù… (Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©)", "Ù„Ø§ (Ø¨Ø§Ù‚Ø© Ø«Ø§Ø¨ØªØ©)")
            bot.send_message(uid, "Ù‡Ù„ Ø§Ù„Ù…Ù†ØªØ¬ ÙŠØªØ·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…ÙŠØ© (Ù…Ø«Ù„ Ø§Ù„Ù†Ù‚Ø§Ø·)ØŸ", reply_markup=mk)
        
        elif st["action"] == "add_prod_is_qty":
            # ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù‚ÙŠÙ… Ù„Ù„Ø¥Ø¯Ø®Ø§Ù„
            p_name = st["prod_name"]
            p_price = st["prod_price"]
            p_usd = st["prod_usd"]
            p_cost = st["cost_price"]
            p_api = st["prod_api"]
            gid = st["gid"]
            med_id = st.get("med_id", 0) # Ø§ÙØªØ±Ø§Ø¶ÙŠ 0 Ø§Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡

            if txt == "Ù†Ø¹Ù… (Ø¢Ù„Ø© Ø­Ø§Ø³Ø¨Ø©)":
                st["is_qty"] = 1
                st["action"] = "add_prod_min_qty"
                bot.send_message(uid, "ğŸ”¢ Ø£Ù‚Ù„ ÙƒÙ…ÙŠØ© Ù„Ù„Ø·Ù„Ø¨:", reply_markup=types.ReplyKeyboardRemove())
            else:
                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø«Ø§Ø¨Øª
                db_query("INSERT INTO products (group_id, name, price, cost_price, api_product_id, is_quantity, min_qty, price_usd, mediator_id) VALUES (?,?,?,?,?,0,1,?,?)", 
                         (gid, p_name, p_price, p_cost, p_api, p_usd, med_id), commit=True)
                bot.send_message(uid, "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ (Ø«Ø§Ø¨Øª)!", reply_markup=types.ReplyKeyboardRemove())
                del admin_states[uid]

        elif st["action"] == "add_prod_min_qty":
            if not txt.isdigit(): return
            min_qty = int(txt)
            p_name = st["prod_name"]
            p_price = st["prod_price"]
            p_usd = st["prod_usd"]
            p_cost = st["cost_price"]
            p_api = st["prod_api"]
            gid = st["gid"]
            med_id = st.get("med_id", 0)

            db_query("INSERT INTO products (group_id, name, price, cost_price, api_product_id, is_quantity, min_qty, price_usd, mediator_id) VALUES (?,?,?,?,?,1,?,?,?)", 
                     (gid, p_name, p_price, p_cost, p_api, min_qty, p_usd, med_id), commit=True)
            bot.send_message(uid, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ (ÙƒÙ…ÙŠØ§Øª)!\nØ£Ù‚Ù„ ÙƒÙ…ÙŠØ©: {min_qty}", reply_markup=types.ReplyKeyboardRemove())
            del admin_states[uid]

        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø­Ø¨
        elif st["action"] == "set_raf_fee":
            if not txt.isdigit(): return
            set_setting("raffle_fee", txt)
            bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ")
            del admin_states[uid]
        elif st["action"] == "set_raf_prize":
            if not txt.isdigit(): return
            set_setting("raffle_prize", txt)
            bot.send_message(uid, "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø§Ø¦Ø²Ø©")
            del admin_states[uid]
        
        # [Ø¬Ø¯ÙŠØ¯] ØªØ¹ÙŠÙŠÙ† Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù
        elif st["action"] == "set_dollar_rate":
            try:
                rate = float(txt)
                set_setting("dollar_rate", str(rate))
                bot.send_message(uid, f"âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù Ø¥Ù„Ù‰: {rate}")
                del admin_states[uid]
            except:
                bot.send_message(uid, "âš ï¸ Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­")

        # Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙ†ÙˆØ¹Ø©
        elif st["action"] == "save_text":
            set_setting(st["key"], txt)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "add_meth_name":
            st["mname"] = txt
            st["action"] = "add_meth_num"
            bot.send_message(uid, "Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø©:")
        elif st["action"] == "add_meth_num":
            st["mnum"] = txt
            st["action"] = "add_meth_desc"
            bot.send_message(uid, "ØªØ¹Ù„ÙŠÙ…Ø§Øª:")
        elif st["action"] == "add_meth_desc":
            db_query("INSERT INTO payment_methods (name, account_number, details) VALUES (?,?,?)", (st["mname"], st["mnum"], txt), commit=True)
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "update_level":
            try:
                n, d, c = txt.split("-")
                db_query("UPDATE levels SET name=?, discount_percent=?, upgrade_cost=? WHERE level_id=?", (n, float(d), int(c), st["lid"]), commit=True)
                bot.send_message(uid, "âœ… ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«")
            except: bot.send_message(uid, "Ø®Ø·Ø£ ØªÙ†Ø³ÙŠÙ‚")
            del admin_states[uid]
        
        # Ø§Ù„Ø¨Ø­Ø«
        elif st["action"] == "search_user":
            if not txt.isdigit(): return
            u = get_user(int(txt))
            if not u: return bot.send_message(uid, "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            lvl = get_level_info(u[3])
            info = f"ğŸ‘¤ {u[1]} (ID: {u[0]})\nğŸ’° {u[2]}\nâ­ {lvl[1]}"
            mk = types.InlineKeyboardMarkup()
            mk.add(types.InlineKeyboardButton("ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰", callback_data=f"set_manual_lvl_{u[0]}"))
            if u[5]: mk.add(types.InlineKeyboardButton("ÙÙƒ Ø§Ù„Ø­Ø¸Ø±", callback_data=f"unban_{u[0]}"))
            else: mk.add(types.InlineKeyboardButton("Ø­Ø¸Ø±", callback_data=f"ban_{u[0]}"))
            bot.send_message(uid, info, reply_markup=mk)
            del admin_states[uid]
            
        elif st["action"] == "adm_quick_lvl_id":
            if not txt.isdigit(): return
            u = get_user(int(txt))
            if not u: return bot.send_message(uid, "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            mk = types.InlineKeyboardMarkup()
            for l in db_query("SELECT * FROM levels", fetch=True):
                mk.add(types.InlineKeyboardButton(f"{l[1]}", callback_data=f"do_set_lvl_{u[0]}_{l[0]}"))
            bot.send_message(uid, f"Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ {u[1]}:", reply_markup=mk)
            del admin_states[uid]

        # Ø§Ù„Ø£Ø±ØµØ¯Ø©
        elif st["action"] == "adm_bal_add_id":
            st["tid"] = int(txt)
            st["action"] = "adm_bal_add_amt"
            bot.send_message(uid, "Ø§Ù„Ù…Ø¨Ù„Øº:")
        elif st["action"] == "adm_bal_add_amt":
            amt = int(txt)
            db_query("UPDATE users SET balance = balance + ? WHERE id=?", (amt, st["tid"]), commit=True)
            bot.send_message(uid, f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {amt}")
            try: bot.send_message(st["tid"], f"ğŸ’° ØªÙ… Ø¥Ø¶Ø§ÙØ© {amt} Ù„Ø±ØµÙŠØ¯Ùƒ")
            except: pass
            del admin_states[uid]
        elif st["action"] == "adm_bal_deduct_id":
            st["tid"] = int(txt)
            st["action"] = "adm_bal_deduct_amt"
            bot.send_message(uid, "Ø§Ù„Ù…Ø¨Ù„Øº:")
        elif st["action"] == "adm_bal_deduct_amt":
            amt = int(txt)
            db_query("UPDATE users SET balance = balance - ? WHERE id=?", (amt, st["tid"]), commit=True)
            bot.send_message(uid, f"âœ… ØªÙ… Ø®ØµÙ… {amt}")
            del admin_states[uid]
        elif st["action"] == "broadcast_text":
            c = broadcast_message(txt)
            bot.send_message(uid, f"âœ… ØªÙ… Ù„Ù€ {c}")
            del admin_states[uid]
        elif st["action"] == "maint_on_msg":
            set_setting("maintenance", "1")
            broadcast_message(f"âš ï¸ ØµÙŠØ§Ù†Ø©:\n{txt}")
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]
        elif st["action"] == "maint_off_msg":
            set_setting("maintenance", "0")
            broadcast_message(f"âœ… Ø¹Ø¯Ù†Ø§:\n{txt}")
            bot.send_message(uid, "âœ… ØªÙ…")
            del admin_states[uid]

# Callback Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ§Ù„Ø­Ø¸Ø±
@bot.callback_query_handler(func=lambda c: c.data.startswith("ban_") or c.data.startswith("unban_") or c.data.startswith("set_manual_lvl_"))
def user_action(call):
    if call.from_user.id != ADMIN_ID: return
    
    if call.data.startswith("set_manual_lvl_"):
        tid = int(call.data.split("_")[3])
        mk = types.InlineKeyboardMarkup()
        for l in db_query("SELECT * FROM levels", fetch=True):
            mk.add(types.InlineKeyboardButton(f"{l[1]}", callback_data=f"do_set_lvl_{tid}_{l[0]}"))
        bot.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø³ØªÙˆÙ‰:", ADMIN_ID, call.message.message_id, reply_markup=mk)
        return

    act, tid = call.data.split("_")
    val = 1 if act == "ban" else 0
    db_query("UPDATE users SET banned=? WHERE id=?", (val, tid), commit=True)
    bot.answer_callback_query(call.id, "ØªÙ…")

print("Bot Ultimate Pro V14 (Dollar + Mediator) Started...")
bot.infinity_polling()
